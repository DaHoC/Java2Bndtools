# Qivicon bnd builder

## Table of Contents
1. [What is it and what does it do](#what-is-it-and-what-does-it-do)
1. [Prerequisites](#prerequisites)
1. [How to install?](#how-to-install)
    1. [Using the Eclipse update site](#using-the-eclipse-update-site-recommended-but-currently-not-working-due-to-permissions)
1. [How to use?](#how-to-use)
    1. [Plugin way (recommended)](#plugin-way-recommended)
    1. [Alternative way 1: Using Eclipse project properties](#alternative-way-1-using-eclipse-project-properties)
    1. [Alternative way 2: Manual way (not recommended)](#alternative-way-2-manual-way-not-recommended)
1. [Example usage](#example-usage)
1. [How does it work?](#how-does-it-work)
1. [Changelog](#changelog)
1. [License](#license)
1. [Open issues & to-do](#open-issues-to-do)

## What is it and what does it do?
It is an Eclipse plugin that provides integration of Java projects into a bndtools workspace, by making java projects available in a local bndtools repository.

![Example Eclipse flow](https://qivicon-wbench.psst.t-online.corp/gitlab/jan.hendriks/QiviconBndBuilder/raw/master/resources/ExampleFlow.jpg "Example Eclipse flow")

## Prerequisites
1. Eclipse workspace with bndtools workspace with the mandatory bnd cnf project folder and a bnd repository named "Local"
1. A Java project (having the org.eclipse.jdt.core.javanature nature) being contained within the same Eclipse workspace
1. The `META-INF/MANIFEST.MF` of the Java project must be present, readable and must have the following attributes (`Bundle-Version` defaults to `0.0.0` if not specified), mind the mandatory newline at the end of the file:

```
Manifest-Version: 1.0
Bundle-Name: Dummy project
Bundle-SymbolicName: com.foo.bar
Bundle-ManifestVersion: 2
Bundle-Version: 2.0.0
```
If your bnd repositories are missing the `Local` repository, you can add the entry to the main `cnf/build.bnd` file:

```
-plugin.7.Local: \
    aQute.bnd.deployer.repository.LocalIndexedRepo; \
    name = Local; \
    pretty = true; \
    local = ${build}/local
```

## How to install?

### Using the Eclipse update site (recommended, but currently not working due to permissions)
The Eclipse update site is generated by the enclosed com.qivicon.bndbuilder.updatesite project (which uses the enclosed com.qivicon.bndbuilder.feature project which in turn uses this con.qivicon.bndbuilder project) and can be found at following URL:

<https://qivicon-wbench.psst.t-online.corp/gitlab/jan.hendriks/QiviconBndBuilder/raw/master/com.qivicon.bndbuilder.updatesite/>

or

<https://qivicon-wbench.wesp.telekom.net/gitlab/jan.hendriks/QiviconBndBuilder/raw/master/com.qivicon.bndbuilder.updatesite/>

Don't mind the HTTP 404 response as the index.html is missing, but Eclipse *should* rely on the existing `site.xml` file

## How to use?
Make sure that the prerequisites are met.

To associate the plugin with a Java project, you need to add a nature (which adds the corresponding builder) to the project you want to provide to the local bndtools workspace.

Each time a *full build* on the Java project is triggered, e.g. by doing a *Project → Clean… → Build (automatically)*, the updated project should appear as bundle in the "Local" bndtools workspace repository.

The name of the bundle corresponds to the `Bundle-SymbolicName` `MANIFEST.MF` entry, the version to `Bundle-Version`.

This bundle can then be referenced by a bnd project.

To associate the plugin with a Java project, there are several approaches:

### Plugin way (recommended)
Select the Java projects which should be considered and included as bnd dependencies in the "Package Explorer" or "Project Explorer" view, right-click to open the context menu → *Add QiviconBndBuilder nature*

![Add project nature via plugin](https://qivicon-wbench.psst.t-online.corp/gitlab/jan.hendriks/QiviconBndBuilder/raw/master/resources/AddProjectNatureViaPlugin.jpg "Add project nature via plugin")

#### Alternative way 1: Using Eclipse project properties
Select the Java project, go into its properties (e.g. by right-clicking the project → *Properties*), select *Project Natures* → *Add...* → *QIVICON bnd builder nature* as depicted below:

![Add project nature](https://qivicon-wbench.psst.t-online.corp/gitlab/jan.hendriks/QiviconBndBuilder/raw/master/resources/AddProjectNature.jpg "Add project nature")

After hitting *Apply and Close*, the project nature is added, the corresponding builder is added and registered and the project is build and should immediately appear in the bnd workspace "Local" repository.

#### Alternative way 2: Manual way (not recommended)
For the Java project add the `com.qivicon.bndbuilder.qiviconbndbuildernature` and `buildCommand` `com.qivicon.bndbuilder.qiviconbndbuilder` as last build entry as shown in the following `.project` entries / builder:

	<?xml version="1.0" encoding="UTF-8"?>
	<projectDescription>
		...
		<buildSpec>
			<buildCommand>
				<name>org.eclipse.jdt.core.javabuilder</name>
				<arguments>
				</arguments>
			</buildCommand>
			<buildCommand>
				<name>com.qivicon.bndbuilder.qiviconbndbuilder</name>
				<arguments>
				</arguments>
			</buildCommand>
		</buildSpec>
		<natures>
			<nature>org.eclipse.jdt.core.javanature</nature>
			<nature>com.qivicon.bndbuilder.qiviconbndbuildernature</nature>
		</natures>
	</projectDescription>

### Example usage
Consider a _Java_ project in your bndtools workspace that has a `Bundle-SymbolicName` of `com.foo.java` and a `Bundle-Version` of `2.1.0` defined in its `META-INF/MANIFEST.MF`.

Besides this project, the `com.bar.bnd` _bndtools_ project is present in the same Eclipse workspace, which is to be configured to require the `com.foo.java` bundle as dependency.

First a full build of the Java project `com.foo.java` is to be done (e.g. by *Project → Clean… → Build (automatically)*).
Afterwards, the corresponding bundle should now be present in the "Local" bndtools workspace repository (see *Bndtools perspective → Repositories → Local*).

`com.foo.java` can now be referenced from the `com.bar.bnd/bnd.bnd` file, e.g.

	-buildpath = com.foo.java;version=2.1.0

The `com.bar.bnd` bndtools project now references the `com.foo.java` bundle as dependency and the exposed API (including JavaDoc) and further bndtools/OSGi instructions can be used (like `Require-Capability`, `Import-Package`, `-runbundles` and so on).

After each successful full build of the `com.foo.java` project, the corresponding bundle in the "Local" bndtools repository is updated.

## How does it work?
If the Java project is given the additional nature (and builder) as mentioned before, the builder registers itself as the last builder to execute in the chain, to make sure it's called after all other builders doing e.g. source generation or resource handling, especially after the Java builder.

During each *full* build of this Java project, the Qivicon bnd builder packs generated Java artifacts of the project into a temporary jar file using the Eclipse-internal jar package exporter with custom settings.

This temporary JAR file is passed via stream to the bnd workspace "Local" repository where it should appear.
It is automatically overwritten for each new full build and the bnd workspace repository is refreshed automatically.

## Changelog

* 1.5.0 Added context menu to batch-add and -remove the Qivicon bnd builder nature, major refactoring, set license EPL-2.0
* 1.4.0 Include package sources to provide Javadoc
* 1.3.0 Added nature to add and remove corresponding builder, renaming, cleanups
* 1.2.0 Added possibility to exlude project files and folders from export
* 1.1.0 Use Eclipse-internal JAR archiver
* 1.0.0 Incremental version

## License
See LICENSE file

## Open issues & to-do
1. Reduce debug output
1. Support incremental builds to some extent if possible
